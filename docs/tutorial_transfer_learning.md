Last update: Jan 14, 2026

# Transfer Learning: peptide candidates, spec lib usage, and decoy handling
A variety of peptide property prediction models ae available in FragPipe, namely DIA-NN and those on the
[Koina server](https://github.com/Nesvilab/MSBooster/blob/master/Koina.md). Though trained on various datasets, these 
models may not know the nuances of your machine or PTMs of interest. Transfer learning takes a base model that knows
the general rules of peptide fragmentation, liquid chromotography, and ion mobility and adapts it on a new dataset. This
has the potential to improve DDA identifications and DIA quantification, the latter of which was limited in previous 
FragPipe editions to only quantifying FDR-filtered peptide candidates from empirically generated libraries. Our transfer
learning relies upon the AlphaPeptDeep transfer learning module

---

## First steps
Before running transfer learning, the server must be set up. Refer to [this tutorial page](https://github.com/Nesvilab/FragPipe_transfer_learn/tree/main)
for instructions on setting it up.

A credential file must be provided to FragPipe ending with the ".key" extension. It has two lines, the server 
URL and API key. The API key can be generated via [HTTP request](https://github.com/Nesvilab/FragPipe_transfer_learn/tree/main?tab=readme-ov-file#generate-api-keys).
Below is an example.

```
http://localhost:8000
apikey-123
```
![credential file](https://raw.githubusercontent.com/Nesvilab/FragPipe/gh-pages/images/credentials_key.png)
---

## Overview and assumptions
Transfer learning in FragPipe can be run **with or without a full MSFragger search**, depending on:

- whether a **training spectral library already exists**
- how peptide candidates for prediction are defined
- how the predicted library will be used downstream (MSBooster, DIA-NN, etc.)

**Important assumptions**

Transfer learning requires a **training spectral library** (typically generated via **MSFragger → Validation → Spec Lib / EasyPQP**).

- **Workflows A–C below assume this training library already exists**
- **Workflow D** describes the full end-to-end case starting directly from raw MS data

---

## Peptide candidate sources

Predicted libraries can be generated from different peptide candidate sources:

![peptides to predict](https://raw.githubusercontent.com/Nesvilab/FragPipe/gh-pages/images/peptides_to_predict.png)

### 1. Whole FASTA
- Peptides are generated by applying **digestion rules from the MSFragger tab**

  ![digestion only](https://raw.githubusercontent.com/Nesvilab/FragPipe/gh-pages/images/digestion_only.png)
- Used when broad peptide coverage is desired
- The minimum and maximum precursor charges can be configured

  ![max min charge](https://raw.githubusercontent.com/Nesvilab/FragPipe/gh-pages/images/max_min_charge_tl.png)

### 2. Restricted candidates (MSFragger search results)
- Peptides are taken **directly from MSFragger PIN files**
- **Digestion parameters are ignored**
- Only peptides observed in the MSFragger search are included

---

## Using an existing library or pre-trained weights

Many of the FragPipe workflows have **Spec Lib** enabled, which generates a library.tsv in the output directory. Once you 
have a `library.tsv` file or pre-trained transfer-learning weights (e.g. from a previous transfer learning job):

- A full MSFragger search is **not required**
- **MSFragger: OFF**
- **Validation tab: OFF**
- Enable **“Digestion only”** in the MSFragger tab (if using Whole FASTA)

Libraries and weights not generated in FragPipe can be used if they follow the appropriate format. Refer to the
[tutorial](https://github.com/Nesvilab/FragPipe_transfer_learn/tree/main/data) for the proper format

![custom lib](https://raw.githubusercontent.com/Nesvilab/FragPipe/gh-pages/images/custom_tl_library.png)

## Outputs
Transfer learning will return a zip file with all model weights and a subfolder containing quality control metrics. There
is no need to unzip the zip folder in our workflows, as the prediction script automatically unzips it.

![model weights zip](https://raw.githubusercontent.com/Nesvilab/FragPipe/gh-pages/images/model_weights_zip.png)

The prediction step supports many output format: speclib (DIA-NN specific format), library.tsv, parquet, and mgf. The
parquet follows the standard library.tsv format. Library.tsv is the current default for our workflows, and we are actively
testing the suitability of the speclib format for our workflows.

![pred output formats](https://raw.githubusercontent.com/Nesvilab/FragPipe/gh-pages/images/pred_output_formats.png)

---

## Decoy handling

- **Keep decoys ON**
    - Required when the predicted library will be used for **MSBooster rescoring**

- **Keep decoys OFF**
    - Required when the predicted library will be used for **DIA quantification in DIA-NN**
    - DIA-NN regenerates decoys internally

      ![keep decoys](https://raw.githubusercontent.com/Nesvilab/FragPipe/gh-pages/images/keep_decoys.png)
---

## Common transfer learning workflows

### Workflow A — DDA-only MSBooster rescoring

**Goal:** Improve DDA peptide identification using a transfer learned model

This can also be use for DIA data, if the goal is not quantification but only identification

**Execution steps:**
0.  Load your training library. An externally generated training library can be provided in the "Load custom spectral 
library for training (optional)" box in the **Transfer Learning** tab. If you are picking up from the end of a FragPipe 
workflow with **Spec Lib** generation enabled, a `library.tsv` should already be in your output directory and you can
leave the box blank.
1. Run **Transfer Learning** and **prediction** to predict a spectral library
2. Reload (or duplicate) the DDA search workflow
    - Load the predicted library into **MSBooster** "Spectral library (optional, experimental) box"
    - **MSFragger: OFF**
    - Rerun with MSBooster rescoring and downstream Validation steps

**Settings for transfer learning and prediction (step 1)**
- MSFragger: OFF
- Validation: OFF
- Spec Lib: OFF
- Peptides to predict: MSFragger search results
- Keep decoys: **ON**

**Settings for rescoring (step 2)**
- MSFragger: OFF
- Validation: ON
- Spec Lib: OFF

![lib upload](https://raw.githubusercontent.com/Nesvilab/FragPipe/gh-pages/images/msbooster_library_upload.png)
---

### Workflow B — DIA library prediction for DIA-NN

**Goal:** Generate a predicted spectral library for DIA analysis in DIA-NN  

**Execution steps:**
0. Load your training library. An externally generated training library can be provided in the "Load custom spectral
    library for training (optional)" box in the **Transfer Learning** tab. If you are picking up from the end of a FragPipe
    workflow with **Spec Lib** generation enabled, a `library.tsv` should already be in your output directory and you can
    leave the box blank.
1. Run **Transfer Learning** and **prediction** to predict a spectral library
2. Run DIA quantification with the **Quant (DIA)** tab, specifying your new library in the "Spectral library (optional)"
box

![diann quant](https://raw.githubusercontent.com/Nesvilab/FragPipe/gh-pages/images/diann_quant_tl.png)

**Settings for transfer learning and prediction (step 1)**
- MSFragger: OFF
- Validation: OFF
- Spec Lib: OFF
- Peptide candidates: Whole FASTA or MSFragger search results
  - The choice of search space depends on if you want more peptides/proteins to quantify outside of those 
  identified by MSFragger
- Keep decoys: **OFF**
  - DIA-NN regenerates decoys internally.

---

### Workflow C — Iterative MSBooster → new predicted DIA library
This is a combination of workflows A and B. The idea is that if MSBooster is given improved predictions, PSM rescoring
by Percolator is improved, generating more IDs at a given FDR threshold. More IDs = more training points for the 
transfer learning

**Goal:** Improve IDs via MSBooster and regenerate a refined predicted library

**Execution steps:**
0. Load your training library. An externally generated training library can be provided in the "Load custom spectral
   library for training (optional)" box in the **Transfer Learning** tab. If you are picking up from the end of a FragPipe
   workflow with **Spec Lib** generation enabled, a `library.tsv` should already be in your output directory and you can
   leave the box blank.
1. Run **Transfer Learning** and **prediction** to predict your **initial spectral library**
2. Reload workflow and rerun search from **MSBooster** using the predicted library. Steps up through the second transfer
learning step can be rerun in one go, generating a second, improved predicted library 
    - Load the predicted library into **MSBooster** "Spectral library (optional, experimental) box"
3. Run DIA quantification with the **Quant (DIA)** tab, specifying your new library in the "Spectral library (optional)"
   box

**Settings for transfer learning and prediction (step 1)**
- MSFragger: OFF
- Validation: OFF
- Spec Lib: OFF
- Peptides to predict: MSFragger search results
- Keep decoys: **ON**

**Settings for rescoring and second transfer learning and prediction (step 2)**
- MSFragger: OFF
- Validation: ON
- Spec Lib: ON
- Transfer Learning: ON

---

### Workflow D — Full end-to-end workflow from raw MS data
Generate a training spectral library from a FragPipe first pass workflow (e.g. one of the workflow files
provided in FragPipe).
This is the generic use case. The ideas here about generating a training library (library.tsv) can be applied in step 0
of the previous workflows.

**Goal:** Train transfer learning weights and generate a predicted library starting from raw MS files

**Typical settings:**
- MSFragger: ON
- Validation: ON
- Spec Lib: ON
- Transfer learning: ON
- Peptide candidates: Whole FASTA or MSFragger search results
- Keep decoys: ON or OFF (depending on downstream use)

---

## Suggestions
### Using MSBooster for the first search
If you believe default prediction models may negatively impact your training library (e.g. chemically very
different PTMs not included in DIA-NN training set), you can try turning off MSBooster in the Validation
tab when you generate your library. Enabling MSBooster may promote modified peptides that behave similarly
to their unmodified counterparts and penalize those with meaningful changes in spectra/retention time/ion
mobility. Once you have a model trained on non-MSBooster rescored candidates, you can upload the predictions into
MSBooster for improved rescoring. It is likely that more peptides will pass FDR in this second search, resulting in
more peptides for training a second model.

### Instrument and NCE
You can specify your instrument and normalized collision energy in the transfer learning tab. Training most likely will
still converge to accurate results even if you leave it at the default values, but the training may converge quicker and
be more accurate if they are defined properly.

![instrument nce](https://raw.githubusercontent.com/Nesvilab/FragPipe/gh-pages/images/instrument_nce.png)

---

## Citations
- Yang, K.L., Yu, F., Teo, G.C. et al. MSBooster: improving peptide identification rates using deep learning-based features.
  Nat Commun 14, 4539 (2023). https://doi.org/10.1038/s41467-023-40129-9
- Zeng, WF., Zhou, XX., Willems, S. et al. AlphaPeptDeep: a modular deep learning framework to predict peptide properties 
for proteomics. Nat Commun 13, 7238 (2022). https://doi.org/10.1038/s41467-022-34904-3